<!DOCTYPE html>
<!--
Socaio - AI-Powered Audience Analysis Tool

SETUP INSTRUCTIONS:
1. Get an OpenAI API key from https://platform.openai.com/api-keys
2. When you first use the tool, you'll be prompted to enter your API key
3. The key will be stored locally in your browser for future use
4. Enter your news content, and the AI will analyze and generate relevant audience characteristics
5. Select or modify the characteristics and generate detailed reaction analysis

FEATURES:
- AI-powered audience characteristic generation
- Dynamic checkbox creation based on news content
- Detailed reaction analysis and insights
- Fallback mode when API is unavailable
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socaio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white;
            color: #1f2937;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            transition: all 0.3s ease;
        }


        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .main-content.split {
            flex: 1;
        }

        /* Initial Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 40px;
            text-align: center;
        }

        .welcome-screen.hidden {
            display: none;
        }

        .greeting {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .query-container {
            width: 100%;
            max-width: 600px;
            position: relative;
        }

        .query-input {
            width: 100%;
            padding: 20px 60px 20px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            color: #1f2937;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .query-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .submit-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #6366f1;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .submit-btn:hover {
            background: #5855eb;
        }

        .submit-btn:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }

        /* Chat Interface */
        .chat-interface {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }

        .chat-interface.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 16px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #1f2937;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: transparent;
            border: none;
            border-bottom-left-radius: 4px;
            padding: 16px 0;
        }

        /* Characteristics Panel */
        .characteristics-panel {
            width: 0;
            background: white;
            border-left: 1px solid #e5e7eb;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .characteristics-panel.active {
            width: 400px;
            padding: 20px;
        }

        .panel-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1f2937;
        }

        .characteristics-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .characteristic-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .characteristic-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .characteristic-item:hover {
            background: #f3f4f6;
            border-color: #6366f1;
        }

        .characteristic-item.selected {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
        }

        .characteristic-item.auto-selected {
            background: #10b981;
            border-color: #10b981;
            color: white;
            position: relative;
        }

        .characteristic-item.auto-selected::after {
            content: 'AI';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #059669;
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 10px;
            font-weight: bold;
        }

        .characteristic-item.auto-selected.selected {
            background: #6366f1;
            border-color: #6366f1;
        }

        .characteristic-item.auto-selected.selected::after {
            background: #4f46e5;
        }

        .characteristic-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #9ca3af;
            border-radius: 3px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .characteristic-item.selected .characteristic-checkbox {
            background: white;
            border-color: white;
        }

        .characteristic-checkbox::after {
            content: '✓';
            color: #6366f1;
            font-size: 10px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .characteristic-item.selected .characteristic-checkbox::after {
            opacity: 1;
        }

        .characteristic-label {
            font-size: 13px;
            flex: 1;
        }

        .generate-btn {
            background: #10b981;
            border: none;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .generate-btn:hover {
            background: #059669;
        }

        .generate-btn:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }

        /* Report Display Styles */
        .report-display {
            height: 100%;
            overflow-y: auto;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .report-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .back-to-characteristics {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .back-to-characteristics:hover {
            background: #4b5563;
        }

        .report-content {
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
        }

        .report-content h4 {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 20px 0 10px 0;
            border-left: 4px solid #6366f1;
            padding-left: 12px;
        }

        .report-content h4:first-child {
            margin-top: 0;
        }

        .report-content p {
            margin-bottom: 12px;
        }

        .report-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .report-content li {
            margin-bottom: 6px;
        }

        .report-content strong {
            color: #1f2937;
            font-weight: 600;
        }

        .report-meta {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .report-meta .meta-item {
            margin-bottom: 8px;
        }

        .report-meta .meta-item:last-child {
            margin-bottom: 0;
        }

        .report-meta strong {
            color: #6b7280;
        }


        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #4b5563;
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .characteristics-panel.active {
                width: 100%;
                position: absolute;
                z-index: 15;
                height: 100%;
            }
            
            .main-content.split {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <div class="main-content" id="mainContent">            
            <div class="welcome-screen" id="welcomeScreen">
                <div class="logo" style="font-size: 32px; font-weight: bold; color: #6366f1; margin-bottom: 20px;">Socaio</div>
                <div class="greeting">How can I help you understand your audience today?</div>
                <div class="query-container">
                    <input type="text" class="query-input" id="queryInput" placeholder="Enter your test message here...">
                    <button class="submit-btn" id="submitBtn">
                        <span id="submitIcon">→</span>
                    </button>
                </div>
            </div>

            <div class="chat-interface" id="chatInterface">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be added here -->
                </div>
            </div>
        </div>

        <div class="characteristics-panel" id="characteristicsPanel">
            <div class="panel-header">Audience Characteristics</div>
            
            <!-- Report Display Area -->
            <div class="report-display" id="reportDisplay" style="display: none;">
                <div class="report-header">
                    <h3>📊 Analysis Report</h3>
                    <button class="back-to-characteristics" id="backToCharacteristics">← Back to Characteristics</button>
                </div>
                <div class="report-content" id="reportContent">
                    <!-- Report content will be displayed here -->
                </div>
            </div>
            
            <!-- Characteristics Selection Area -->
            <div class="characteristics-content" id="characteristicsContent">
            <div class="characteristics-section">
                <div class="section-title">Age Groups</div>
                <div class="characteristic-grid">
                    <div class="characteristic-item" data-value="18-24">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">18-24</div>
                    </div>
                    <div class="characteristic-item" data-value="25-34">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">25-34</div>
                    </div>
                    <div class="characteristic-item" data-value="35-44">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">35-44</div>
                    </div>
                    <div class="characteristic-item" data-value="45-54">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">45-54</div>
                    </div>
                </div>
            </div>

            <div class="characteristics-section">
                <div class="section-title">Gender</div>
                <div class="characteristic-grid">
                    <div class="characteristic-item" data-value="male">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Male</div>
                    </div>
                    <div class="characteristic-item" data-value="female">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Female</div>
                    </div>
                    <div class="characteristic-item" data-value="non-binary">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Non-binary</div>
                    </div>
                    <div class="characteristic-item" data-value="prefer-not-to-say">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Prefer not to say</div>
                    </div>
                </div>
            </div>

            <div class="characteristics-section">
                <div class="section-title">Personality Traits</div>
                <div class="characteristic-grid">
                    <div class="characteristic-item" data-value="curious">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Curious</div>
                    </div>
                    <div class="characteristic-item" data-value="ambitious">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Ambitious</div>
                    </div>
                    <div class="characteristic-item" data-value="conservative">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Conservative</div>
                    </div>
                    <div class="characteristic-item" data-value="progressive">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Progressive</div>
                    </div>
                    <div class="characteristic-item" data-value="analytical">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Analytical</div>
                    </div>
                    <div class="characteristic-item" data-value="creative">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Creative</div>
                    </div>
                </div>
            </div>

            <div class="characteristics-section">
                <div class="section-title">Interests</div>
                <div class="characteristic-grid">
                    <div class="characteristic-item" data-value="technology">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Technology</div>
                    </div>
                    <div class="characteristic-item" data-value="sports">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Sports</div>
                    </div>
                    <div class="characteristic-item" data-value="arts">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Arts</div>
                    </div>
                    <div class="characteristic-item" data-value="business">
                        <div class="characteristic-checkbox"></div>
                        <div class="characteristic-label">Business</div>
                    </div>
                </div>
            </div>

            <button class="generate-btn" id="generateBtn">Generate Analysis Report</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Environment variable injection
        const OPENAI_API_KEY = '{{OPENAI_API_KEY}}'; // Will be replaced at build time
        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';

        // State management
        let currentQuery = '';
        let selectedCharacteristics = new Set();
        let generatedCharacteristics = {};

        // DOM elements
        const mainContent = document.getElementById('mainContent');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatInterface = document.getElementById('chatInterface');
        const characteristicsPanel = document.getElementById('characteristicsPanel');
        const queryInput = document.getElementById('queryInput');
        const submitBtn = document.getElementById('submitBtn');
        const submitIcon = document.getElementById('submitIcon');
        const chatMessages = document.getElementById('chatMessages');
        let generateBtn = document.getElementById('generateBtn');
        let reportDisplay = document.getElementById('reportDisplay');
        let reportContent = document.getElementById('reportContent');
        let characteristicsContent = document.getElementById('characteristicsContent');
        let backToCharacteristics = document.getElementById('backToCharacteristics');

        // Initialize app
        function init() {
            setupEventListeners();
            queryInput.focus();
        }

        function setupEventListeners() {
            // Submit query
            submitBtn.addEventListener('click', handleQuerySubmit);
            queryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleQuerySubmit();
            });

            // Characteristic selection
            document.querySelectorAll('.characteristic-item').forEach(item => {
                item.addEventListener('click', () => toggleCharacteristic(item));
            });

            // Generate report
            generateBtn.addEventListener('click', generateReport);

            // Back to characteristics button
            backToCharacteristics.addEventListener('click', () => {
                showCharacteristics();
            });
        }

        async function handleQuerySubmit() {
            const query = queryInput.value.trim();
            if (!query) return;

            currentQuery = query;
            
            // Show loading state
            submitIcon.innerHTML = '<div class="loading"></div>';
            submitBtn.disabled = true;

            // Switch to chat interface
            welcomeScreen.classList.add('hidden');
            chatInterface.classList.add('active');
            mainContent.classList.add('split');
            characteristicsPanel.classList.add('active');
            
            addMessage('user', query);
            addMessage('assistant', "Analyzing your news content and generating audience characteristics...");

            try {
                console.log('Starting AI analysis for:', query);
                
                // Analyze the news with AI
                const characteristics = await analyzeNewsWithAI(query);
                generatedCharacteristics = characteristics;

                console.log('AI analysis completed:', characteristics);

                // Update the characteristics panel with AI-generated content
                updateCharacteristicsPanel(characteristics);

                // Update the assistant message
                updateLastAssistantMessage("I've analyzed your news content and identified the most relevant audience characteristics. The AI has auto-selected the primary characteristics based on the content, but you can modify these selections. Click 'Generate Analysis Report' when ready.");

            } catch (error) {
                console.error('Error during analysis:', error);
                console.log('Using fallback characteristics due to error');
                
                updateLastAssistantMessage("I've generated some general audience characteristics for your analysis. AI analysis is currently unavailable - using fallback mode. Please select the traits you'd like to focus on and click 'Generate Analysis Report'.");
                
                // Use fallback characteristics
                const fallbackChars = getFallbackCharacteristics();
                updateCharacteristicsPanel(fallbackChars);
            }

            // Reset submit button
            submitIcon.innerHTML = '→';
            submitBtn.disabled = false;
        }

        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function toggleCharacteristic(item) {
            const value = item.dataset.value;
            
            if (selectedCharacteristics.has(value)) {
                selectedCharacteristics.delete(value);
                item.classList.remove('selected');
            } else {
                selectedCharacteristics.add(value);
                item.classList.add('selected');
            }
            
            updateGenerateButton();
        }

        function updateGenerateButton() {
            generateBtn.disabled = selectedCharacteristics.size === 0;
            generateBtn.textContent = selectedCharacteristics.size > 0 
                ? `Generate Analysis Report (${selectedCharacteristics.size} traits selected)`
                : 'Generate Analysis Report';
        }

        async function generateReport() {
            console.log('generateReport called');
            console.log('selectedCharacteristics:', selectedCharacteristics);
            console.log('currentQuery:', currentQuery);
            
            if (selectedCharacteristics.size === 0) {
                console.log('No characteristics selected, returning');
                return;
            }

            console.log('Setting loading state...');
            generateBtn.innerHTML = '<div class="loading"></div> Generating Report...';
            generateBtn.disabled = true;

            const traits = Array.from(selectedCharacteristics);
            
            try {
                console.log('Calling generateReactionAnalysis with:', { currentQuery, traits });
                // Generate AI-powered reaction analysis
                const analysisReport = await generateReactionAnalysis(currentQuery, traits);
                console.log('Got analysis report:', analysisReport);
                
                // Display report in right panel
                console.log('Displaying report...');
                displayReport(currentQuery, traits, analysisReport);
                
            } catch (error) {
                console.error('Error generating report:', error);
                const fallbackReport = `
                <h4>Overall Analysis</h4>
                <p>This content would likely resonate with the selected demographic based on their characteristics.</p>
                
                <h4>Engagement Patterns</h4>
                <p>Audience engagement patterns suggest varying levels of interest and emotional response based on the selected traits.</p>
                
                <h4>Recommendations</h4>
                <ul>
                    <li>Tailor messaging to address specific concerns of this demographic</li>
                    <li>Consider cultural and generational factors when crafting communication strategy</li>
                    <li>Monitor engagement metrics to validate assumptions</li>
                    <li>Test different messaging approaches with this audience segment</li>
                </ul>
                
                <p><em>Note: Full AI analysis temporarily unavailable. Using general recommendations.</em></p>
                `;
                
                displayReport(currentQuery, traits, fallbackReport);
            }

            // Reset generate button
            generateBtn.innerHTML = 'Generate New Analysis';
            generateBtn.disabled = false;
        }

        function displayReport(query, traits, analysisContent) {
            console.log('displayReport called with:', { query, traits, analysisContent });
            console.log('reportContent element:', reportContent);
            
            // Create report HTML
            const reportHTML = `
                <div class="report-meta">
                    <div class="meta-item">
                        <strong>News Content:</strong> ${query.length > 100 ? query.substring(0, 100) + '...' : query}
                    </div>
                    <div class="meta-item">
                        <strong>Selected Traits:</strong> ${traits.join(', ')}
                    </div>
                    <div class="meta-item">
                        <strong>Generated:</strong> ${new Date().toLocaleString()}
                    </div>
                </div>
                
                ${formatAnalysisContent(analysisContent)}
            `;

            // Display in right panel
            console.log('Setting reportContent.innerHTML...');
            reportContent.innerHTML = reportHTML;
            console.log('Calling showReport...');
            showReport();
        }

        function formatAnalysisContent(content) {
            // If content is already HTML (fallback case), return as is
            if (content.includes('<h4>') || content.includes('<ul>')) {
                return content;
            }
            
            // Format plain text analysis into HTML
            const lines = content.split('\n');
            let formattedHTML = '';
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                // Headers (lines ending with :)
                if (line.endsWith(':') && !line.includes('•') && !line.includes('-')) {
                    formattedHTML += `<h4>${line.replace(':', '')}</h4>`;
                }
                // List items (starting with • or -)
                else if (line.startsWith('•') || line.startsWith('-')) {
                    if (!formattedHTML.includes('<ul>') || formattedHTML.lastIndexOf('</ul>') > formattedHTML.lastIndexOf('<ul>')) {
                        formattedHTML += '<ul>';
                    }
                    formattedHTML += `<li>${line.replace(/^[•-]\s*/, '')}</li>`;
                }
                // Regular paragraphs
                else {
                    // Close any open lists
                    if (formattedHTML.includes('<ul>') && formattedHTML.lastIndexOf('<ul>') > formattedHTML.lastIndexOf('</ul>')) {
                        formattedHTML += '</ul>';
                    }
                    formattedHTML += `<p>${line}</p>`;
                }
            }
            
            // Close any remaining open lists
            if (formattedHTML.includes('<ul>') && formattedHTML.lastIndexOf('<ul>') > formattedHTML.lastIndexOf('</ul>')) {
                formattedHTML += '</ul>';
            }
            
            return formattedHTML || '<p>Analysis completed successfully.</p>';
        }

        function showReport() {
            console.log('showReport called');
            console.log('characteristicsContent:', characteristicsContent);
            console.log('reportDisplay:', reportDisplay);
            
            if (characteristicsContent) {
                characteristicsContent.style.display = 'none';
                console.log('Hidden characteristicsContent');
            }
            if (reportDisplay) {
                reportDisplay.style.display = 'block';
                console.log('Showed reportDisplay');
            }
        }

        function showCharacteristics() {
            reportDisplay.style.display = 'none';
            characteristicsContent.style.display = 'block';
        }


        function updateCharacteristicsPanel(characteristics) {
            const panelContent = document.querySelector('#characteristicsPanel');
            const newHTML = `
                <div class="panel-header">AI-Generated Audience Characteristics</div>
                
                <!-- Report Display Area -->
                <div class="report-display" id="reportDisplay" style="display: none;">
                    <div class="report-header">
                        <h3>📊 Analysis Report</h3>
                        <button class="back-to-characteristics" id="backToCharacteristics">← Back to Characteristics</button>
                    </div>
                    <div class="report-content" id="reportContent">
                        <!-- Report content will be displayed here -->
                    </div>
                </div>
                
                <!-- Characteristics Selection Area -->
                <div class="characteristics-content" id="characteristicsContent">
                ${generateCharacteristicsHTML(characteristics)}
                <button class="generate-btn" id="generateBtn">Generate Analysis Report</button>
                </div>
            `;
            
            panelContent.innerHTML = newHTML;
            
            // Reattach event listeners
            setupCharacteristicListeners();
            
            // Auto-select primary characteristics and update state
            selectedCharacteristics.clear();
            document.querySelectorAll('.characteristic-item.auto-selected').forEach(item => {
                const value = item.dataset.value;
                selectedCharacteristics.add(value);
                item.classList.add('selected');
            });
            
            updateGenerateButton();
        }

        function setupCharacteristicListeners() {
            // Re-setup characteristic selection listeners
            document.querySelectorAll('.characteristic-item').forEach(item => {
                item.addEventListener('click', () => toggleCharacteristic(item));
            });
            
            // Re-setup generate button listener
            const newGenerateBtn = document.getElementById('generateBtn');
            if (newGenerateBtn) {
                newGenerateBtn.addEventListener('click', generateReport);
            }
            
            // Re-setup back button listener
            const newBackBtn = document.getElementById('backToCharacteristics');
            if (newBackBtn) {
                newBackBtn.addEventListener('click', () => {
                    showCharacteristics();
                });
            }
            
            // Update DOM element references
            const newReportDisplay = document.getElementById('reportDisplay');
            const newReportContent = document.getElementById('reportContent');
            const newCharacteristicsContent = document.getElementById('characteristicsContent');
            const newBackToCharacteristics = document.getElementById('backToCharacteristics');
            
            if (newReportDisplay) reportDisplay = newReportDisplay;
            if (newReportContent) reportContent = newReportContent;
            if (newCharacteristicsContent) characteristicsContent = newCharacteristicsContent;
            if (newBackToCharacteristics) backToCharacteristics = newBackToCharacteristics;
            if (newGenerateBtn) generateBtn = newGenerateBtn;
        }

        function updateLastAssistantMessage(newContent) {
            const messages = chatMessages.querySelectorAll('.message.assistant');
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                const contentDiv = lastMessage.querySelector('.message-content');
                contentDiv.textContent = newContent;
            }
        }

        function goBackToMainPage() {
            // Reset to initial state
            welcomeScreen.classList.remove('hidden');
            chatInterface.classList.remove('active');
            mainContent.classList.remove('split');
            characteristicsPanel.classList.remove('active');
            
            // Clear chat messages
            chatMessages.innerHTML = '';
            
            // Reset form
            queryInput.value = '';
            currentQuery = '';
            selectedCharacteristics.clear();
            generatedCharacteristics = {};
            
            // Reset characteristics panel to original state
            resetCharacteristicsPanel();
            
            // Show characteristics (not report)
            showCharacteristics();
            
            // Focus on input
            queryInput.focus();
        }

        function resetCharacteristicsPanel() {
            const originalHTML = `
                <div class="panel-header">Audience Characteristics</div>
                
                <!-- Report Display Area -->
                <div class="report-display" id="reportDisplay" style="display: none;">
                    <div class="report-header">
                        <h3>📊 Analysis Report</h3>
                        <button class="back-to-characteristics" id="backToCharacteristics">← Back to Characteristics</button>
                    </div>
                    <div class="report-content" id="reportContent">
                        <!-- Report content will be displayed here -->
                    </div>
                </div>
                
                <!-- Characteristics Selection Area -->
                <div class="characteristics-content" id="characteristicsContent">
                <div class="characteristics-section">
                    <div class="section-title">Age Groups</div>
                    <div class="characteristic-grid">
                        <div class="characteristic-item" data-value="18-24">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">18-24</div>
                        </div>
                        <div class="characteristic-item" data-value="25-34">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">25-34</div>
                        </div>
                        <div class="characteristic-item" data-value="35-44">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">35-44</div>
                        </div>
                        <div class="characteristic-item" data-value="45-54">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">45-54</div>
                        </div>
                    </div>
                </div>

                <div class="characteristics-section">
                    <div class="section-title">Gender</div>
                    <div class="characteristic-grid">
                        <div class="characteristic-item" data-value="male">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Male</div>
                        </div>
                        <div class="characteristic-item" data-value="female">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Female</div>
                        </div>
                        <div class="characteristic-item" data-value="non-binary">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Non-binary</div>
                        </div>
                        <div class="characteristic-item" data-value="prefer-not-to-say">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Prefer not to say</div>
                        </div>
                    </div>
                </div>

                <div class="characteristics-section">
                    <div class="section-title">Personality Traits</div>
                    <div class="characteristic-grid">
                        <div class="characteristic-item" data-value="curious">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Curious</div>
                        </div>
                        <div class="characteristic-item" data-value="ambitious">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Ambitious</div>
                        </div>
                        <div class="characteristic-item" data-value="conservative">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Conservative</div>
                        </div>
                        <div class="characteristic-item" data-value="progressive">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Progressive</div>
                        </div>
                        <div class="characteristic-item" data-value="analytical">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Analytical</div>
                        </div>
                        <div class="characteristic-item" data-value="creative">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Creative</div>
                        </div>
                    </div>
                </div>

                <div class="characteristics-section">
                    <div class="section-title">Interests</div>
                    <div class="characteristic-grid">
                        <div class="characteristic-item" data-value="technology">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Technology</div>
                        </div>
                        <div class="characteristic-item" data-value="sports">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Sports</div>
                        </div>
                        <div class="characteristic-item" data-value="arts">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Arts</div>
                        </div>
                        <div class="characteristic-item" data-value="business">
                            <div class="characteristic-checkbox"></div>
                            <div class="characteristic-label">Business</div>
                        </div>
                    </div>
                </div>

                <button class="generate-btn" id="generateBtn">Generate Analysis Report</button>
                </div>
            `;
            
            characteristicsPanel.innerHTML = originalHTML;
            setupEventListeners();
        }

        // OpenAI API integration
        async function analyzeNewsWithAI(newsContent) {
            console.log('Calling OpenAI API with content:', newsContent.substring(0, 100) + '...');
            
            // Check if API key is properly injected
            if (!OPENAI_API_KEY || OPENAI_API_KEY === '{{OPENAI_API_KEY}}') {
                console.error('API key not properly injected at build time');
                throw new Error('API key not configured');
            }
            
            try {
                const response = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'user',
                            content: `Analyze this news content and identify the key audience characteristics that would be most relevant for understanding public reaction. Provide your analysis in the following JSON format:

{
  "primary_demographics": {
    "age_groups": ["25-34", "35-44"],
    "gender": ["male", "female"],
    "education": ["college", "graduate"]
  },
  "interests": ["technology", "business"],
  "personality_traits": ["analytical", "progressive", "curious"],
  "additional_options": {
    "age_groups": ["18-24", "45-54", "55+"],
    "personality_traits": ["conservative", "traditional", "skeptical"],
    "interests": ["finance", "sports", "entertainment"]
  }
}

News content to analyze: "${newsContent}"`
                        }],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });

                console.log('OpenAI API response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('OpenAI API error:', errorText);
                    throw new Error(`OpenAI API error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('OpenAI API response data:', data);
                
                const analysisText = data.choices[0].message.content;
                console.log('Analysis text received:', analysisText);
                
                try {
                    return JSON.parse(analysisText);
                } catch (parseError) {
                    console.log('JSON parsing failed, using fallback extraction');
                    // If JSON parsing fails, extract characteristics manually
                    return extractCharacteristicsFromText(analysisText);
                }
            } catch (error) {
                console.error('Error analyzing news:', error);
                throw error; // Re-throw so the calling function can handle it
            }
        }

        async function generateReactionAnalysis(newsContent, selectedTraits) {
            try {
                const response = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'user',
                            content: `Provide a detailed analysis of how an audience with these characteristics would likely react to this news:

Audience Characteristics: ${selectedTraits.join(', ')}

News Content: "${newsContent}"

Please provide:
1. Overall emotional reaction (positive/negative/mixed/neutral)
2. Key concerns or interests this audience would have
3. Likely engagement behavior (share, comment, ignore, etc.)
4. Potential misconceptions or areas of confusion
5. Recommended messaging adjustments for this audience
6. Cultural or demographic-specific considerations

Format your response as a comprehensive analysis report.`
                        }],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate reaction analysis');
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('Error generating analysis:', error);
                return 'Unable to generate analysis at this time. Please check your API configuration and try again.';
            }
        }

        function extractCharacteristicsFromText(text) {
            // Fallback function to extract characteristics if JSON parsing fails
            return {
                primary_demographics: {
                    age_groups: ["25-34", "35-44"],
                    gender: ["male", "female"]
                },
                interests: ["technology", "business"],
                personality_traits: ["analytical", "curious"],
                additional_options: {
                    age_groups: ["18-24", "45-54"],
                    personality_traits: ["conservative", "progressive"]
                }
            };
        }

        function getFallbackCharacteristics() {
            // Fallback characteristics when API is not available
            return {
                primary_demographics: {
                    age_groups: ["25-34", "35-44"],
                    gender: ["male", "female"],
                    education: ["college"]
                },
                interests: ["technology", "business"],
                personality_traits: ["analytical", "curious"],
                additional_options: {
                    age_groups: ["18-24", "45-54"],
                    personality_traits: ["conservative", "progressive"],
                    interests: ["sports", "entertainment"]
                }
            };
        }

        function generateCharacteristicsHTML(characteristics) {
            let html = '';
            
            // Age Groups
            if (characteristics.primary_demographics?.age_groups || characteristics.additional_options?.age_groups) {
                const primary = characteristics.primary_demographics?.age_groups || [];
                const additional = characteristics.additional_options?.age_groups || [];
                const allAges = [...new Set([...primary, ...additional])];
                
                html += `
                <div class="characteristics-section">
                    <div class="section-title">Age Groups</div>
                    <div class="characteristic-grid">
                        ${allAges.map(age => `
                            <div class="characteristic-item ${primary.includes(age) ? 'auto-selected' : ''}" data-value="${age}" data-category="age">
                                <div class="characteristic-checkbox"></div>
                                <div class="characteristic-label">${age}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }

            // Gender
            if (characteristics.primary_demographics?.gender) {
                const genders = ['male', 'female', 'non-binary', 'prefer-not-to-say'];
                const primaryGenders = characteristics.primary_demographics.gender;
                
                html += `
                <div class="characteristics-section">
                    <div class="section-title">Gender</div>
                    <div class="characteristic-grid">
                        ${genders.map(gender => `
                            <div class="characteristic-item ${primaryGenders.includes(gender) ? 'auto-selected' : ''}" data-value="${gender}" data-category="gender">
                                <div class="characteristic-checkbox"></div>
                                <div class="characteristic-label">${gender.charAt(0).toUpperCase() + gender.slice(1).replace('-', ' ')}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }

            // Personality Traits
            if (characteristics.personality_traits || characteristics.additional_options?.personality_traits) {
                const primary = characteristics.personality_traits || [];
                const additional = characteristics.additional_options?.personality_traits || [];
                const allTraits = [...new Set([...primary, ...additional])];
                
                html += `
                <div class="characteristics-section">
                    <div class="section-title">Personality Traits</div>
                    <div class="characteristic-grid">
                        ${allTraits.map(trait => `
                            <div class="characteristic-item ${primary.includes(trait) ? 'auto-selected' : ''}" data-value="${trait}" data-category="personality">
                                <div class="characteristic-checkbox"></div>
                                <div class="characteristic-label">${trait.charAt(0).toUpperCase() + trait.slice(1)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }

            // Interests
            if (characteristics.interests || characteristics.additional_options?.interests) {
                const primary = characteristics.interests || [];
                const additional = characteristics.additional_options?.interests || [];
                const allInterests = [...new Set([...primary, ...additional])];
                
                html += `
                <div class="characteristics-section">
                    <div class="section-title">Interests</div>
                    <div class="characteristic-grid">
                        ${allInterests.map(interest => `
                            <div class="characteristic-item ${primary.includes(interest) ? 'auto-selected' : ''}" data-value="${interest}" data-category="interests">
                                <div class="characteristic-checkbox"></div>
                                <div class="characteristic-label">${interest.charAt(0).toUpperCase() + interest.slice(1)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }

            // Education Level
            if (characteristics.primary_demographics?.education) {
                const educationLevels = ['high-school', 'college', 'graduate', 'postgraduate'];
                const primaryEducation = characteristics.primary_demographics.education;
                
                html += `
                <div class="characteristics-section">
                    <div class="section-title">Education Level</div>
                    <div class="characteristic-grid">
                        ${educationLevels.map(edu => `
                            <div class="characteristic-item ${primaryEducation.includes(edu) ? 'auto-selected' : ''}" data-value="${edu}" data-category="education">
                                <div class="characteristic-checkbox"></div>
                                <div class="characteristic-label">${edu.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }

            return html;
        }

        // Initialize the app
        init();
    </script>
</body>
</html>